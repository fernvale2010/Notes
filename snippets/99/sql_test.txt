

-- Create test table
CREATE TABLE csvtest (
  Id       VARCHAR2(30),
  CAN      NUMBER(16),
  PTC      NUMBER(16),
  Amount   NUMBER(8,2),,
  TXN_Date DATE
);


delete from csvtest;
commit;


INSERT INTO csvtest VALUES ('ID_AAAAAA1111', 1111111111, 10, 10.00, to_date('20-01-17 00:00:00', 'dd-MM-yy HH24:mi:SS'));
INSERT INTO csvtest VALUES ('ID_AAAAAA2222', 1111112222, -1, 10.00, to_date('20-01-17 00:00:00', 'dd-MM-yy HH24:mi:SS'));
INSERT INTO csvtest VALUES ('ID_AAAAAA3333', 1111113333, 10, 10.00, to_date('20-01-17 00:00:00', 'dd-MM-yy HH24:mi:SS'));
INSERT INTO csvtest VALUES ('ID_AAAAAA4444', 1111114444, 10, 10.00, to_date('20-01-17 00:00:00', 'dd-MM-yy HH24:mi:SS'));
INSERT INTO csvtest VALUES ('ID_AAAAAA2222', 1111112222, 10, 10.00, to_date('20-01-17 00:00:00', 'dd-MM-yy HH24:mi:SS'));
INSERT INTO csvtest VALUES ('ID_AAAAAA4444', 1111114444, 10, 10.00, to_date('20-01-17 00:00:00', 'dd-MM-yy HH24:mi:SS'));
INSERT INTO csvtest VALUES ('ID_AAAAAA4444', 1111114444, -1, 10.00, to_date('20-01-17 00:00:00', 'dd-MM-yy HH24:mi:SS'));
INSERT INTO csvtest VALUES ('ID_AAAAAA5555', 1111115555, -1, 10.00, to_date('20-01-17 00:00:00', 'dd-MM-yy HH24:mi:SS'));
INSERT INTO csvtest VALUES ('ID_AAAAAA6666', 1111116666, -1, 10.00, to_date('20-01-17 00:00:00', 'dd-MM-yy HH24:mi:SS'));
INSERT INTO csvtest VALUES ('ID_AAAAAA6666', 1111116666, 20, 10.00, to_date('20-01-17 00:00:00', 'dd-MM-yy HH24:mi:SS'));
commit;


--duplicates are:
-- 'ID_AAAAAA4444', 1111114444, 10,
-- 'ID_AAAAAA4444', 1111114444, 10,
-- 'ID_AAAAAA4444', 1111114444, -1

-- 'ID_AAAAAA2222', 1111112222, -1,
-- 'ID_AAAAAA2222', 1111112222, 10,

-- 'ID_AAAAAA6666', 1111116666, -1,
-- 'ID_AAAAAA6666', 1111116666, 20,

--To keep only: (so delete 4 rows)
-- 'ID_AAAAAA4444', 1111114444, 10,
-- 'ID_AAAAAA2222', 1111112222, 10,
-- 'ID_AAAAAA6666', 1111116666, 20,


So result should be:
'ID_AAAAAA1111', 1111111111, 10,
'ID_AAAAAA3333', 1111113333, 10,
'ID_AAAAAA2222', 1111112222, 10,
'ID_AAAAAA4444', 1111114444, 10,
'ID_AAAAAA5555', 1111115555, -1,
'ID_AAAAAA6666', 1111116666, 20,





select count(*), can, id from csvtest
group by can, id having count(*) > 1;


-----------------------------------------------------
#01
delete from csvtest a
where a.rowid <
(select max(b.rowid)
 from csvtest b
 where a.id = b.id and
 a.can = b.can); 

Result:
ID_AAAAAA3333   1111113333  10  10  1/20/2017
ID_AAAAAA1111   1111111111  10  10  1/20/2017
ID_AAAAAA2222   1111112222  10  10  1/20/2017
ID_AAAAAA4444   1111114444  -1  10  1/20/2017
ID_AAAAAA5555   1111115555  -1  10  1/20/2017
ID_AAAAAA6666   1111116666  20  10  1/20/2017

-----------------------------------------------------
#02
-- step 1
delete from csvtest a where a.rowid <
(select max(b.rowid) from csvtest b
 where a.id = b.id and a.can = b.can and a.PTC = b.PTC);  <== deletes one of 'ID_AAAAAA4444', 1111114444, 10,

-- step 2
delete from csvtest a where a.rowid <
(select max(b.rowid) from csvtest b
 where a.id = b.id and a.can = b.can) and (a.PTC < 0);  <== deletes those with ptc < 0 whose row comes before those with ptc > 0.


ID_AAAAAA3333   1111113333  10  10  1/20/2017
ID_AAAAAA2222   1111112222  10  10  1/20/2017
ID_AAAAAA4444   1111114444  10  10  1/20/2017
ID_AAAAAA4444   1111114444  -1  10  1/20/2017
ID_AAAAAA5555   1111115555  -1  10  1/20/2017
ID_AAAAAA6666   1111116666  20  10  1/20/2017
ID_AAAAAA1111   1111111111  10  10  1/20/2017

-----------------------------------------------------
#03
delete from csvtest where rowid in (select rowid from
(select id, can, row_number() over (partition by id, can order by ptc desc) rw from csvtest)
where rw > 1);

results:
ID_AAAAAA1111   1111111111  10  10  1/20/2017
ID_AAAAAA3333   1111113333  10  10  1/20/2017
ID_AAAAAA4444   1111114444  10  10  1/20/2017
ID_AAAAAA2222   1111112222  10  10  1/20/2017
ID_AAAAAA5555   1111115555  -1  10  1/20/2017
ID_AAAAAA6666   1111116666  20  10  1/20/2017



-----------------------------------------------------
-- PTC desc
select * from (
select id, can, ptc, row_number() over (partition by id, can order by ptc desc) rw from csvtest) where rw > 1;

ID_AAAAAA2222   1111112222  -1  2
ID_AAAAAA4444   1111114444  10  2
ID_AAAAAA4444   1111114444  -1  3
ID_AAAAAA6666   1111116666  -1  2


-- PTC asc
select * from (
select id, can, ptc, row_number() over (partition by id, can order by ptc asc) rw from csvtest) where rw > 1;

ID_AAAAAA2222   1111112222  10  2
ID_AAAAAA4444   1111114444  10  2
ID_AAAAAA4444   1111114444  10  3
ID_AAAAAA6666   1111116666  20  2




-----------------------------------------------------

delete from hr.employees
where rowid in
 (select rowid
 from
 (select first_name, last_name, rowid,
 row_number() over
 (partition by first_name, last_name order by employee_id)
 staff_row
 from hr.employees)
 where staff_row > 1); 

----------------------------------------------------

DELETE FROM csvtest t1 WHERE EXISTS ( SELECT 'x' FROM csvtest t2
    WHERE t2.CAN = t1.CAN AND ((t2.ID=t1.ID) OR (t2.ID IS NULL AND t1.ID IS NULL)) AND t2.amount=t1.amount AND t2.rowid > t1.rowid)

ID_AAAAAA3333   1111113333  10  10  1/20/2017
ID_AAAAAA2222   1111112222  10  10  1/20/2017
ID_AAAAAA4444   1111114444  -1  10  1/20/2017
ID_AAAAAA5555   1111115555  -1  10  1/20/2017
ID_AAAAAA6666   1111116666  20  10  1/20/2017
ID_AAAAAA1111   1111111111  10  10  1/20/2017
